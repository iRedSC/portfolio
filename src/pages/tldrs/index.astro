---
import Layout from '../../layouts/Layout.astro';
import TldrFilter from '../../components/TldrFilter.tsx';
import { getCollection } from 'astro:content';

const tldrs = await getCollection('tldrs', ({ data }) => !data.draft);

const tldrItems = tldrs
  .map((entry) => ({
    title: entry.data.title,
    description: entry.data.description,
    pubDate: entry.data.pubDate,
    tags: entry.data.tags ?? [],
    slug: entry.slug,
  }))
  .sort((a, b) => b.pubDate.getTime() - a.pubDate.getTime());

const tldrsForFilter = tldrItems.map((t) => ({
  slug: t.slug,
  title: t.title,
  description: t.description,
  tags: t.tags,
  pubDate: t.pubDate.toISOString(),
}));
---

<Layout
  title="TLDRs | Portfolio"
  description="Quick summaries and insights on various topics - technology, books, courses, and more."
>
  <section class="section">
    <div class="section-title section-title--divider section-title--centered">
      <div class="section-title__group">
        <span class="section-title__line" aria-hidden="true"></span>
        <h1 class="section-title__heading">TLDRs</h1>
        <span class="section-title__line" aria-hidden="true"></span>
      </div>
    </div>
    <p class="lead" style="text-align: center; margin: -0.5rem 0 1.5rem;">
      Quick summaries and key takeaways from books, courses, conferences,
      and other learning experiences.
    </p>

    <TldrFilter tldrs={tldrsForFilter} client:only="react">
      <div class="blog-filter" slot="fallback" aria-hidden="true">
        <div class="filter-controls">
          <div class="search-container">
            <input type="text" placeholder="Search TLDRs..." class="search-input" disabled aria-hidden="true" />
          </div>
          <div class="tags-container">
            <div class="tags-list">
              {tldrsForFilter.flatMap((t: any) => t.tags).filter((tag: string, i: number, a: string[]) => a.indexOf(tag) === i).sort().slice(0, 8).map((tag: string) => (
                <span class="tag-chip">{tag}</span>
              ))}
            </div>
          </div>
        </div>
        <div class="filter-results">
          <span class="results-count">{tldrItems.length} of {tldrItems.length} TLDRs</span>
        </div>
      </div>
    </TldrFilter>

    <div id="filtered-tldrs" class="tldrs-list">
      {tldrItems.map((tldr: any) => (
        <a href={`/tldrs/${tldr.slug}`} class="tldr-card">
          <h2 class="tldr-title">{tldr.title}</h2>
          <p class="tldr-description">{tldr.description}</p>
          <div class="tldr-meta">
            <time datetime={tldr.pubDate.toISOString()}>
              {tldr.pubDate.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
              })}
            </time>
            <div class="tldr-tags">
              {tldr.tags.map((tag: string) => (
                <span class="tag">{tag}</span>
              ))}
            </div>
          </div>
        </a>
      ))}
    </div>

    {tldrItems.length === 0 && (
      <div class="empty-state">
        <p>No TLDRs available yet. Check back soon!</p>
      </div>
    )}
  </section>
</Layout>

<script define:vars={{ tldrsJson: JSON.stringify(tldrsForFilter) }}>
  function escapeHtml(s) {
    if (s == null) return '';
    const div = document.createElement('div');
    div.textContent = String(s);
    return div.innerHTML;
  }

  function formatDate(isoStr) {
    try {
      return new Date(isoStr).toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
      });
    } catch {
      return '';
    }
  }

  function renderTldrCard(tldr) {
    const tags = Array.isArray(tldr.tags) ? tldr.tags : [];
    const tagsHtml = tags
      .map(
        (tag) =>
          `<button type="button" class="tag tag-clickable" data-tag="${escapeHtml(tag)}" aria-label="Filter by ${escapeHtml(tag)}">${escapeHtml(tag)}</button>`
      )
      .join('');

    return `
      <a href="/tldrs/${escapeHtml(tldr.slug)}" class="tldr-card">
        <h2 class="tldr-title">${escapeHtml(tldr.title)}</h2>
        <p class="tldr-description">${escapeHtml(tldr.description)}</p>
        <div class="tldr-meta">
          <time datetime="${escapeHtml(tldr.pubDate)}">${escapeHtml(formatDate(tldr.pubDate))}</time>
          <div class="tldr-tags">${tagsHtml}</div>
        </div>
      </a>
    `;
  }

  function updateFilteredTldrs(filteredTldrs) {
    const listEl = document.getElementById('filtered-tldrs');
    if (!listEl) return;
    const all = typeof tldrsJson !== 'undefined' ? JSON.parse(tldrsJson) : [];
    const list = Array.isArray(filteredTldrs) ? filteredTldrs : all;
    listEl.innerHTML = list.map((t) => renderTldrCard(t)).join('');
  }

  window.addEventListener('filteredTldrsUpdate', (e) => {
    updateFilteredTldrs(e.detail ?? []);
  });

  document.getElementById('filtered-tldrs')?.addEventListener('click', (e) => {
    const target = e.target.closest('.tag-clickable');
    if (!target) return;
    e.preventDefault();
    e.stopPropagation();
    const tag = target.dataset.tag;
    if (tag) window.dispatchEvent(new CustomEvent('filterByTag', { detail: { tag } }));
  });
</script>

<style>
  .empty-state {
    text-align: center;
    padding: 3rem;
    color: var(--muted);
  }
</style>