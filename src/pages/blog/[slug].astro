---
import PostLayout from '../../layouts/PostLayout.astro';
import { getCollection } from 'astro:content';
import { getReadingTimeMinutes } from '../../lib/readingTime';

import birds from '../../assets/background_videos/birds.mp4';
import dots from '../../assets/background_videos/dots.mp4';
import net from '../../assets/background_videos/net.mp4';

export const prerender = true;

const VIDEOS = [birds, dots, net];

function hashString(str: string): number {
	let h = 0;
	for (let i = 0; i < str.length; i++) {
		h = (h << 5) - h + str.charCodeAt(i);
		h = h & h;
	}
	return Math.abs(h);
}

function pickVideo(slug: string): string {
	return VIDEOS[hashString(slug) % VIDEOS.length];
}

export async function getStaticPaths() {
	const entries = await getCollection('blog', ({ data }) => !data.draft);
	return entries.map((entry) => ({ params: { slug: entry.slug }, props: { entry } }));
}

const { entry } = Astro.props;
const { Content, headings } = await entry.render();
const readingTime = getReadingTimeMinutes(entry.body);
const toc = headings
	.filter((h) => h.depth === 2 || h.depth === 3)
	.map((h) => ({ depth: h.depth, slug: h.slug, text: h.text }));
const backgroundVideo = pickVideo(entry.slug);
---

<PostLayout
	title={entry.data.title}
	description={entry.data.description}
	image={entry.data.image}
	publishedDate={entry.data.pubDate}
	readingTime={`${readingTime} min read`}
	toc={toc}
	backgroundVideo={backgroundVideo}
>
	<Content />
</PostLayout>
