---
import Layout from '../../layouts/Layout.astro';
import BlogFilter from '../../components/BlogFilter.tsx';
import { getCollection } from 'astro:content';
import { getReadingTimeMinutes } from '../../lib/readingTime';

const blogPosts = await getCollection('blog', ({ data }) => !data.draft);

const posts = blogPosts
  .map((entry) => ({
    title: entry.data.title,
    description: entry.data.description,
    pubDate: entry.data.pubDate,
    tags: entry.data.tags ?? [],
    slug: entry.slug,
    readingTime: getReadingTimeMinutes(entry.body),
  }))
  .sort((a, b) => b.pubDate.getTime() - a.pubDate.getTime());
---

<Layout
  title="Blog | Portfolio"
  description="Read my latest thoughts on web development, technology, and software engineering."
>
  <section class="section">
    <div class="section-title section-title--divider section-title--centered">
      <div class="section-title__group">
        <span class="section-title__line" aria-hidden="true"></span>
        <h1 class="section-title__heading">Blog</h1>
        <span class="section-title__line" aria-hidden="true"></span>
      </div>
    </div>
    <p class="lead" style="text-align: center; margin: -0.5rem 0 1.5rem;">
      Thoughts on web development, technology, and software engineering.
    </p>

    <BlogFilter
      posts={posts}
      client:only="react"
    >
      <!-- Fallback: filter UI + placeholder cards to avoid layout shift -->
      <div slot="fallback" aria-hidden="true">
        <div class="blog-filter">
          <div class="filter-controls">
            <div class="search-container">
              <input type="text" placeholder="Search posts..." class="search-input" disabled />
            </div>
            <div class="tags-container">
              <div class="tags-list">
                {posts.flatMap((p: any) => p.tags).filter((t: string, i: number, a: string[]) => a.indexOf(t) === i).sort().slice(0, 8).map((tag: string) => (
                  <span class="tag-chip">{tag}</span>
                ))}
              </div>
            </div>
          </div>
          <div class="filter-results">
            <span class="results-count">{posts.length} of {posts.length} posts</span>
          </div>
        </div>
        <div id="filtered-posts" class="card-grid blog-cards-with-video">
          {posts.map((post: any) => (
            <a href={`/blog/${post.slug}`} class="blog-card blog-card--video blog-card--fallback">
              <div class="blog-card-content">
                <div class="blog-card-top">
                  <h3 class="blog-title">{post.title}</h3>
                  <p class="blog-description">{post.description}</p>
                </div>
                <div class="blog-card-bottom">
                  <div class="blog-tags">
                    {(post.tags ?? []).map((tag: string) => (
                      <span class="tag">{tag}</span>
                    ))}
                  </div>
                  <div class="blog-meta">
                    <time datetime={post.pubDate.toISOString()}>{post.pubDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</time>
                    {post.readingTime ? <span class="reading-time">{post.readingTime} min read</span> : ''}
                  </div>
                </div>
              </div>
            </a>
          ))}
        </div>
      </div>
    </BlogFilter>
  </section>
</Layout>

<style>
  #filtered-posts.card-grid {
    grid-template-columns: repeat(3, 1fr);
  }

  @media (max-width: 768px) {
    #filtered-posts.card-grid {
      grid-template-columns: 1fr;
      gap: 1.5rem;
    }
  }
</style>
